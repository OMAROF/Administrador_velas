<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Velas Artesanales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.16/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem; /* text-base */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #10b981;
            color: white;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 1rem; /* text-base */
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #059669;
        }
         .btn-download {
            background-color: #3b82f6;
            color: white;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 1rem; /* text-base */
            transition: background-color 0.2s;
        }
        .btn-download:hover {
            background-color: #2563eb;
        }
        .btn-neutral {
            background-color: #6b7280;
            color: white;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 1rem; /* text-base */
            transition: background-color 0.2s;
        }
        .btn-neutral:hover {
            background-color: #4b5563;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-xs {
            padding: 0.125rem 0.75rem; /* 2px 12px */
            font-size: 0.75rem; /* text-xs */
            border-radius: 0.375rem;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem; /* text-base */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px #c7d2fe;
        }
        .table-header {
            background-color: #f3f4f6;
            color: #4b5563;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .summary-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: 0.5rem 0.5rem 0 0;
            font-weight: 600;
            background-color: #e5e7eb;
            color: #4b5563;
            transition: all 0.2s;
        }
        .tab:hover {
            background-color: #d1d5db;
        }
        .tab.active {
            background-color: white;
            color: #4f46e5;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.75rem;
            line-height: 1;
            cursor: pointer;
            color: #9ca3af;
            padding: 0.5rem;
        }
        .modal-close-btn:hover {
            color: #1f2937;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased text-gray-800">

    <!-- Contenedor de Autenticación -->
    <div id="auth-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-md">
        <div class="card">
            <h2 id="auth-title" class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" class="input-field" required="">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="login-password" class="input-field" required="">
                </div>
                <p id="auth-error" class="text-sm text-red-600 hidden"></p>
                <button type="submit" class="btn-primary w-full">Iniciar Sesión</button>
            </form>

            <form id="register-form" class="space-y-4 hidden">
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="register-email" class="input-field" required="">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña (mínimo 6 caracteres)</label>
                    <input type="password" id="register-password" class="input-field" required="">
                </div>
                <button type="submit" class="btn-primary w-full">Crear Cuenta</button>
            </form>

            <div class="relative my-4">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">O continúa con</span>
                </div>
            </div>

            <div>
                <button type="button" id="google-signin-btn" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#4285F4" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#34A853" d="M24,44c5.166,0,9.86-1.977,13.257-5.256l-6.522-5.025C28.506,35.593,26.38,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.506,39.58,16.227,44,24,44z"></path><path fill="#FBBC05" d="M12.717,28.083c-0.599-1.802-0.599-3.754,0-5.556l-6.522-5.025C4.146,20.123,3,23.83,3,28c0,4.17,1.146,7.877,3.195,10.475L12.717,28.083z"></path><path fill="#EA4335" d="M24,12c2.956,0,5.482,1.088,7.336,2.826l6.044-6.044C34.396,4.182,29.632,2,24,2C16.227,2,9.506,6.42,6.195,12.525l6.522,5.025C14.381,15.317,18.798,12,24,12z"></path></svg>
                    <span>Iniciar sesión con Google</span>
                </button>
            </div>

            <div class="text-center mt-4">
                <a href="#" id="toggle-auth-mode" class="text-sm text-indigo-600 hover:underline">¿No tienes cuenta? Regístrate</a>
            </div>
        </div>
    </div>

    <!-- Contenedor Principal de la App (inicialmente oculto) -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
            <header class="mb-8">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center">
                    <div class="text-center md:text-left">
                        <h1 class="text-3xl font-bold text-gray-900">Gestor de Velas Artesanales</h1>
                        <p class="mt-2 text-lg text-gray-600">Calcula costos y administra tu catálogo de productos.</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex items-center justify-center flex-shrink-0">
                        <span id="user-email" class="text-sm text-gray-600 mr-4 truncate"></span>
                        <div id="share-container" class="mr-4 hidden flex items-center gap-2">
                            <button id="compartir-catalogo-btn" class="btn-secondary btn-sm">Compartir Catálogo</button>
                            <span id="mensaje-copiado" class="text-sm text-green-600 hidden">¡Copiado!</span>
                        </div>
                        <button id="logout-btn" class="btn-danger flex-shrink-0">Cerrar Sesión</button>
                    </div>
                </div>
            </header>

            <!-- Pestañas de Navegación -->
            <div class="mb-8">
                <div class="overflow-x-auto pb-2">
                    <nav class="flex space-x-2" aria-label="Tabs">
                        <button id="tab-catalogo" class="tab flex-shrink-0">Catálogo</button>
                        <button id="tab-agregar-producto" class="tab flex-shrink-0">Agregar producto</button>
                        <button id="tab-propuesta" class="tab flex-shrink-0">Propuesta de Venta</button>
                        <button id="tab-insumos" class="tab flex-shrink-0">Mis Insumos</button>
                    </nav>
                </div>
            </div>

            <!-- Sección del Catálogo -->
            <div id="seccion-catalogo">
                <div class="card mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="text" id="filtro-catalogo-nombre" placeholder="Buscar por nombre..." class="input-field flex-grow">
                        <select id="filtro-catalogo-categoria" class="input-field w-full md:w-64"></select>
                    </div>
                </div>
                <div id="catalogo-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Las tarjetas del catálogo se insertarán aquí -->
                     <p id="catalogo-vacio-msg" class="text-center text-gray-500 col-span-full">El catálogo está vacío. Guarda una receta desde la sección 'Agregar producto' para empezar.</p>
                </div>
                <div id="catalogo-paginacion" class="flex justify-center items-center space-x-4 mt-8">
                    <!-- Los controles de paginación se insertarán aquí -->
                </div>
            </div>

            <!-- Sección de Agregar Producto -->
            <div id="seccion-agregar-producto" class="hidden">
                <main class="grid grid-cols-1 lg:grid-cols-2 lg:gap-8">
                     <!-- Columna Izquierda: Ingredientes y Receta -->
                <div>
                     <!-- Sección para Información de la receta -->
                     <div class="card">
                        <h2 class="text-xl font-semibold mb-4">Información de la Receta</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="receta-nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Receta</label>
                                <input type="text" id="receta-nombre" placeholder="Ej: Vela Aromática de Lavanda" class="input-field">
                            </div>
                            <div>
                                <label for="receta-caracteristicas" class="block text-sm font-medium text-gray-700 mb-1">Características</label>
                                <textarea id="receta-caracteristicas" rows="2" placeholder="Ej: Relajante y floral" class="input-field"></textarea>
                            </div>
                            <div>
                                <label for="receta-categoria" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                                <input type="text" id="receta-categoria" list="categorias-sugeridas" placeholder="Ej: Navideña, Floral, Cítrica" class="input-field">
                                <datalist id="categorias-sugeridas">
                                    <option value="Navidad"></option>
                                    <option value="Bautizos"></option>
                                    <option value="Bodas"></option>
                                    <option value="Cumpleaños"></option>
                                    <option value="Floral"></option>
                                    <option value="Frutal"></option>
                                    <option value="Cítrica"></option>
                                    <option value="Relajante"></option>
                                </datalist>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fotos del Producto (hasta 4)</label>
                                <div id="contenedor-imagenes" class="grid grid-cols-2 gap-4 mt-2">
                                    <!-- Contenedor para Imagen 1 -->
                                    <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                        <input type="file" id="receta-imagen-1" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*" data-index="1">
                                        <img id="imagen-preview-1" src="" alt="Vista previa 1" class="absolute inset-0 w-full h-full object-cover rounded-lg hidden">
                                        <div id="placeholder-1" class="text-gray-500">
                                            <svg class="mx-auto h-12 w-12" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 0 0-4 4v20m32-12v8m0 0v8a4 4 0 0 1-4 4H12a4 4 0 0 1-4-4v-4m32-4l-3.172-3.172a4 4 0 0 0-5.656 0L28 28M8 32l9.172-9.172a4 4 0 0 1 5.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                            <p class="mt-1 text-sm">Click para subir</p>
                                        </div>
                                    </div>
                                    <!-- Contenedor para Imagen 2 -->
                                    <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                        <input type="file" id="receta-imagen-2" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*" data-index="2">
                                        <img id="imagen-preview-2" src="" alt="Vista previa 2" class="absolute inset-0 w-full h-full object-cover rounded-lg hidden">
                                        <div id="placeholder-2" class="text-gray-500">
                                            <svg class="mx-auto h-12 w-12" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 0 0-4 4v20m32-12v8m0 0v8a4 4 0 0 1-4 4H12a4 4 0 0 1-4-4v-4m32-4l-3.172-3.172a4 4 0 0 0-5.656 0L28 28M8 32l9.172-9.172a4 4 0 0 1 5.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                            <p class="mt-1 text-sm">Click para subir</p>
                                        </div>
                                    </div>
                                    <!-- Contenedor para Imagen 3 -->
                                    <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                        <input type="file" id="receta-imagen-3" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*" data-index="3">
                                        <img id="imagen-preview-3" src="" alt="Vista previa 3" class="absolute inset-0 w-full h-full object-cover rounded-lg hidden">
                                        <div id="placeholder-3" class="text-gray-500">
                                            <svg class="mx-auto h-12 w-12" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 0 0-4 4v20m32-12v8m0 0v8a4 4 0 0 1-4 4H12a4 4 0 0 1-4-4v-4m32-4l-3.172-3.172a4 4 0 0 0-5.656 0L28 28M8 32l9.172-9.172a4 4 0 0 1 5.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                            <p class="mt-1 text-sm">Click para subir</p>
                                        </div>
                                    </div>
                                    <!-- Contenedor para Imagen 4 -->
                                    <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                        <input type="file" id="receta-imagen-4" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*" data-index="4">
                                        <img id="imagen-preview-4" src="" alt="Vista previa 4" class="absolute inset-0 w-full h-full object-cover rounded-lg hidden">
                                        <div id="placeholder-4" class="text-gray-500">
                                            <svg class="mx-auto h-12 w-12" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 0 0-4 4v20m32-12v8m0 0v8a4 4 0 0 1-4 4H12a4 4 0 0 1-4-4v-4m32-4l-3.172-3.172a4 4 0 0 0-5.656 0L28 28M8 32l9.172-9.172a4 4 0 0 1 5.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                            <p class="mt-1 text-sm">Click para subir</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección para agregar ingredientes -->
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4">Paso 1: Agrega los Ingredientes</h2>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <div class="md:col-span-2">
                                <label for="ingrediente" class="block text-sm font-medium text-gray-700 mb-1">Ingrediente</label>
                                <select id="ingrediente" class="input-field"></select>
                            </div>
                            <div>
                                <label for="cantidad" class="block text-sm font-medium text-gray-700 mb-1">Cantidad (g/ml)</label>
                                <input type="number" id="cantidad" placeholder="Ej: 100" class="input-field">
                            </div>
                            <div class="md:col-span-2">
                                <button id="agregar-btn" class="btn-primary w-full">Agregar a la Receta</button>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de la receta actual -->
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4">Paso 2: Revisa tu Receta</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 table-fixed w-full">
                                <thead class="table-header">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Ingrediente</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Cant. (g/ml/pz)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">%</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Costo</th>
                                        <th class="relative px-4 py-3 w-16"><span class="sr-only">Eliminar</span></th>
                                    </tr>
                                </thead>
                                <tbody id="lista-receta" class="bg-white divide-y divide-gray-200">
                                    <tr id="fila-vacia-receta">
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">Aún no has agregado ingredientes.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha: Gastos y Precio Final -->
                <div>
                    <!-- Sección para gastos adicionales -->
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4">Paso 3: Agrega Gastos Adicionales</h2>
                        <div class="space-y-4">
                            <div class="border-b border-gray-200 pb-4">
                                <h3 class="text-lg font-medium text-gray-800 mb-2">Gastos Fijos (%)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="gasto-perdida-pct" class="block text-sm font-medium text-gray-700">Costos por perdida (%)</label>
                                        <div class="flex items-center gap-2 mt-1">
                                            <input type="number" id="gasto-perdida-pct" value="5" class="input-field w-24">
                                            <span id="gasto-perdida-monto" class="text-sm text-gray-600 font-medium">$0.00</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="gasto-produccion-pct" class="block text-sm font-medium text-gray-700">Costos de produccion (%)</label>
                                        <div class="flex items-center gap-2 mt-1">
                                            <input type="number" id="gasto-produccion-pct" value="20" class="input-field w-24">
                                            <span id="gasto-produccion-monto" class="text-sm text-gray-600 font-medium">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="pt-4">
                                <h3 class="text-lg font-medium text-gray-800 mb-2">Gastos Manuales</h3>
                                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                                    <div class="md:col-span-2">
                                        <label for="gasto-descripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                                        <input type="text" id="gasto-descripcion" placeholder="Ej: Etiquetas" class="input-field">
                                    </div>
                                    <div>
                                        <label for="gasto-monto" class="block text-sm font-medium text-gray-700 mb-1">Monto ($)</label>
                                        <input type="number" id="gasto-monto" placeholder="Ej: 15" class="input-field">
                                    </div>
                                    <div class="md:col-span-2">
                                        <button id="agregar-gasto-btn" class="btn-secondary w-full">Agregar Gasto</button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto mt-4">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="table-header">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Descripción</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Monto</th>
                                                <th class="relative px-4 py-3"><span class="sr-only">Eliminar</span></th>
                                            </tr>
                                        </thead>
                                        <tbody id="lista-gastos" class="bg-white divide-y divide-gray-200">
                                            <tr id="fila-vacia-gastos">
                                                <td colspan="3" class="px-6 py-4 text-center text-gray-500">Aún no has agregado gastos.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de cálculo de precio final -->
                    <div class="card">
                         <h2 class="text-xl font-semibold mb-4">Paso 4: Calcula el Precio Final</h2>
                         <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label for="ganancia-minorista" class="block text-sm font-medium text-gray-700">Margen Minorista (%)</label>
                                <input type="number" id="ganancia-minorista" value="150" class="input-field mt-1">
                            </div>
                            <div>
                                <label for="ganancia-mayorista" class="block text-sm font-medium text-gray-700">Margen Mayorista (%)</label>
                                <input type="number" id="ganancia-mayorista" value="100" class="input-field mt-1">
                            </div>
                        </div>
                        <div class="summary-card mt-6 space-y-4">
                            <div class="flex justify-between items-center">
                                <p class="text-sm text-gray-600">Costo Total Producción:</p>
                                <p id="costo-total-produccion" class="text-lg font-semibold text-gray-900">$0.00</p>
                            </div>
                            <div class="border-t border-gray-200 pt-4 mt-4">
                                <p class="text-sm font-semibold text-indigo-600">PRECIO VENTA MINORISTA:</p>
                                <p id="precio-final-minorista" class="text-2xl font-extrabold text-indigo-700">$0.00</p>
                            </div>
                            <div class="border-t border-gray-200 pt-4 mt-4">
                                <p class="text-sm font-semibold text-teal-600">PRECIO VENTA MAYORISTA:</p>
                                <p id="precio-final-mayorista" class="text-2xl font-extrabold text-teal-700">$0.00</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-[-1rem]">
                        <button id="nuevo-registro-btn" class="btn-neutral w-full sm:w-auto">Nuevo Registro</button>
                        <button id="descargar-reporte-btn" class="btn-download w-full sm:w-auto">Descargar PDF</button>
                        <button id="guardar-catalogo-btn" class="btn-primary w-full sm:w-auto">Guardar en Catálogo</button>
                    </div>
                </div>
                </main>
            </div>

            <!-- Sección de Propuesta de Venta -->
            <div id="seccion-propuesta" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Columna Izquierda: Detalles de la Propuesta y Cliente -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="card">
                            <h2 class="text-xl font-semibold mb-4">Detalles de la Propuesta</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="propuesta-numero" class="block text-sm font-medium text-gray-700">Propuesta #</label>
                                    <span id="propuesta-numero" class="text-lg font-bold text-gray-800 mt-1 block">#0001</span>
                                </div>
                                <div>
                                    <label for="propuesta-fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                                    <input type="text" id="propuesta-fecha" class="input-field mt-1">
                                </div>
                                <div>
                                    <label for="propuesta-validez" class="block text-sm font-medium text-gray-700">Válida Hasta</label>
                                    <input type="text" id="propuesta-validez" class="input-field mt-1">
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h2 class="text-xl font-semibold mb-4">Información del Cliente</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="propuesta-cliente-nombre" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                    <input type="text" id="propuesta-cliente-nombre" class="input-field mt-1">
                                </div>
                                <div>
                                    <label for="propuesta-cliente-telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                                    <input type="tel" id="propuesta-cliente-telefono" class="input-field mt-1">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="propuesta-cliente-email" class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" id="propuesta-cliente-email" class="input-field mt-1">
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h2 class="text-xl font-semibold mb-4">Agregar Productos a la Propuesta</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-6 items-end">
                                <div class="md:col-span-2">
                                    <label for="propuesta-producto" class="block text-sm font-medium text-gray-700">Producto del Catálogo</label>
                                    <select id="propuesta-producto" class="input-field mt-1"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tipo de Precio</label>
                                    <div class="flex items-center space-x-4 mt-1 bg-white p-2 rounded-md border border-gray-300">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="tipo-precio-propuesta" value="minorista" class="form-radio h-4 w-4 text-indigo-600" checked>
                                            <span class="ml-2 text-sm text-gray-700">Minorista</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="tipo-precio-propuesta" value="mayorista" class="form-radio h-4 w-4 text-indigo-600">
                                            <span class="ml-2 text-sm text-gray-700">Mayorista</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label for="propuesta-cantidad" class="block text-sm font-medium text-gray-700">Cantidad</label>
                                    <input type="number" id="propuesta-cantidad" value="1" class="input-field mt-1">
                                </div>
                                <div class="md:col-span-2">
                                    <button id="propuesta-agregar-producto-btn" class="btn-primary w-full">Agregar</button>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h2 class="text-xl font-semibold mb-4">Pedido</h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="table-header">
                                        <tr>
                                            <th class="px-4 py-3 text-left">Producto</th>
                                            <th class="px-4 py-3 text-left">Cant.</th>
                                            <th class="px-4 py-3 text-left">P. Unit.</th>
                                            <th class="px-4 py-3 text-left">Total</th>
                                            <th class="relative px-4 py-3"><span class="sr-only">Eliminar</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="propuesta-lista-productos" class="bg-white divide-y divide-gray-200">
                                        <!-- Filas de productos -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                         <div class="card">
                            <h2 class="text-xl font-semibold mb-4">Observaciones y Firma</h2>
                            <div>
                                <label for="propuesta-observaciones" class="block text-sm font-medium text-gray-700">Observaciones Adicionales</label>
                                <textarea id="propuesta-observaciones" rows="3" class="input-field mt-1"></textarea>
                            </div>
                            <div class="mt-4">
                                 <label class="block text-sm font-medium text-gray-700">Firma de Aceptación</label>
                                 <div class="mt-1 p-2 border border-gray-300 rounded-md bg-white">
                                    <canvas id="propuesta-firma-canvas" width="400" height="150"></canvas>
                                 </div>
                                 <div class="flex justify-between items-center mt-2">
                                    <input type="text" id="propuesta-firmante-nombre" placeholder="Nombre de quien firma" class="input-field w-2/3">
                                    <button id="propuesta-limpiar-firma-btn" class="btn-neutral">Limpiar Firma</button>
                                 </div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna Derecha: Resumen y Acciones -->
                    <div class="lg:col-span-1">
                        <div class="card sticky top-8">
                            <h2 class="text-xl font-semibold mb-4">Resumen Financiero</h2>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center text-lg">
                                    <span>Subtotal</span>
                                    <span id="propuesta-subtotal">$0.00</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 items-center border-t pt-4">
                                    <label for="propuesta-impuesto-pct" class="text-sm font-medium">Impuestos (%)</label>
                                    <input type="number" id="propuesta-impuesto-pct" value="16" class="input-field text-right">
                                </div>
                                <div class="grid grid-cols-2 gap-4 items-center">
                                    <label for="propuesta-descuento" class="text-sm font-medium">Descuento ($)</label>
                                    <input type="number" id="propuesta-descuento" value="0" class="input-field text-right">
                                </div>
                                 <div class="grid grid-cols-2 gap-4 items-center">
                                    <label for="propuesta-envio" class="text-sm font-medium">Envío ($)</label>
                                    <input type="number" id="propuesta-envio" value="0" class="input-field text-right">
                                </div>
                                <div class="border-t pt-4 space-y-2">
                                     <div class="flex justify-between items-center text-sm">
                                        <span>Impuestos</span>
                                        <span id="propuesta-impuesto-resumen">$0.00</span>
                                    </div>
                                     <div class="flex justify-between items-center text-sm">
                                        <span>Descuento</span>
                                        <span id="propuesta-descuento-resumen" class="text-red-600">-$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center text-sm">
                                        <span>Envío</span>
                                        <span id="propuesta-envio-resumen">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center text-2xl font-bold text-gray-900 mt-2">
                                        <span>TOTAL</span>
                                        <span id="propuesta-total">$0.00</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 space-y-3">
                                <button id="propuesta-guardar-btn" class="btn-primary w-full">Guardar Propuesta</button>
                                <button id="propuesta-pdf-btn" class="btn-download w-full">Generar PDF</button>
                                <button id="propuesta-limpiar-btn" class="btn-neutral w-full">Limpiar Formulario</button>
                                <button id="propuesta-ver-guardadas-btn" class="btn-secondary w-full">Ver Guardadas</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Gestión de Insumos -->
            <div id="seccion-insumos" class="hidden">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-6">Gestionar Mis Insumos</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Columna del Formulario -->
                        <div class="lg:col-span-1">
                            <form id="form-insumo" class="space-y-4 p-4 border rounded-lg bg-gray-50">
                                <h3 id="form-insumo-titulo" class="text-xl font-semibold">Agregar Nuevo Insumo</h3>
                                <input type="hidden" id="insumo-id">
                                <div>
                                    <label for="insumo-nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                                    <input type="text" id="insumo-nombre" class="input-field" required>
                                </div>
                                <div>
                                    <label for="insumo-precio" class="block text-sm font-medium text-gray-700 mb-1">Precio (por g/ml/pz)</label>
                                    <input type="number" id="insumo-precio" step="0.01" class="input-field" required>
                                </div>
                                <div>
                                    <label for="insumo-categoria" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                                    <input type="text" id="insumo-categoria" class="input-field" required>
                                </div>
                                <div class="flex gap-4">
                                    <button type="submit" id="btn-guardar-insumo" class="btn-primary w-full">Guardar</button>
                                    <button type="button" id="btn-cancelar-edicion-insumo" class="btn-neutral w-full hidden">Cancelar</button>
                                </div>
                            </form>
                        </div>
                        <!-- Columna de la Tabla -->
                        <div class="lg:col-span-2">
                            <div class="mb-4">
                                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                                    <!-- Filtros -->
                                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                                        <input type="text" id="filtro-insumo-nombre" placeholder="Buscar por nombre..." class="input-field w-full md:w-64">
                                        <select id="filtro-insumo-categoria" class="input-field w-full md:w-64"></select>
                                    </div>
                                    <!-- Botones movidos a la parte inferior -->
                                </div>
                            </div>
                            <div class="overflow-y-auto" style="max-height: 60vh;">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="table-header sticky top-0">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Nombre</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Precio</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Categoría</th>
                                            <th class="relative px-4 py-3"><span class="sr-only">Acciones</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-insumos" class="bg-white divide-y divide-gray-200">
                                        <!-- Los insumos se insertarán aquí -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 flex flex-col md:flex-row justify-end items-center gap-4">
                                <input type="file" id="input-excel" class="hidden" accept=".xlsx, .xls, .csv">
                                <button id="btn-cargar-excel" class="btn-secondary w-full md:w-auto">Cargar desde Excel</button>
                                <button id="btn-descargar-datos" class="btn-download w-full md:w-auto">Descargar Respaldo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>



    <!-- Modal para Detalles de Vela -->
    <div id="detalle-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content relative">
            <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            <div id="detalle-modal-content"></div>
        </div>
    </div>

    <!-- Modal para Lista de Propuestas Guardadas -->
    <div id="lista-propuestas-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content relative">
            <button id="lista-propuestas-modal-close-btn" class="modal-close-btn">&times;</button>
            <h2 class="text-2xl font-bold mb-4">Propuestas Guardadas</h2>
            <div id="lista-propuestas-container" class="overflow-y-auto" style="max-height: 70vh;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="table-header">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">#</th>
                            <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Cliente</th>
                            <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Fecha</th>
                            <th class="px-4 py-3 text-left text-xs font-medium tracking-wider">Total</th>
                            <th class="relative px-4 py-3"><span class="sr-only">Acciones</span></th>
                        </tr>
                    </thead>
                    <tbody id="tabla-propuestas-guardadas" class="bg-white divide-y divide-gray-200">
                        <!-- Las filas de propuestas se insertarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Confirmación de Borrado de Imagen -->
    <div id="confirmar-borrado-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content relative w-auto">
            <h3 class="text-lg font-bold mb-4">Confirmar Eliminación</h3>
            <p id="confirmar-borrado-mensaje">¿Estás seguro de que quieres eliminar esta imagen? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="btn-cancelar-borrado" class="btn-neutral">Cancelar</button>
                <button id="btn-confirmar-borrado" class="btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // =================================================================
            // 1. INICIALIZACIÓN Y CONFIGURACIÓN
            // =================================================================
            const firebaseConfig = {
                apiKey: "AIzaSyCHGc-cNmZoP_ieRCP6Qxr-EG8QGGU7LgU",
                authDomain: "adminvelas.firebaseapp.com",
                projectId: "adminvelas",
                storageBucket: "adminvelas.firebasestorage.app",
                messagingSenderId: "765865245335",
                appId: "1:765865245335:web:f8bb3269151cdbce8607d2"
            };

            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            const storage = firebase.storage();

            // =================================================================
            // 2. VARIABLES GLOBALES DE ESTADO
            // =================================================================
            let currentUser = null;
            let productos = [];
            let receta = [];
            let gastosAdicionales = [];
            let catalogo = [];
            let propuestasGuardadas = [];
            let propuestaActual = { cliente: {}, detalles: {}, pedido: [], costos: {} };
            let paginaActualCatalogo = 1;
            const itemsPorPagina = 6;

            // =================================================================
            // 3. DECLARACIÓN DE ELEMENTOS DE LA UI
            // =================================================================
            // --- Contenedores principales
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');

            // --- Autenticación
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const toggleAuthLink = document.getElementById('toggle-auth-mode');
            const authTitle = document.getElementById('auth-title');
            const authError = document.getElementById('auth-error');
            const logoutBtn = document.getElementById('logout-btn');
            const userEmailSpan = document.getElementById('user-email');
            const googleSignInBtn = document.getElementById('google-signin-btn');

            // --- Pestañas y Secciones
            const tabAgregarProducto = document.getElementById('tab-agregar-producto');
            const tabCatalogo = document.getElementById('tab-catalogo');
            const tabPropuesta = document.getElementById('tab-propuesta');
            const tabInsumos = document.getElementById('tab-insumos');
            const seccionAgregarProducto = document.getElementById('seccion-agregar-producto');
            const seccionCatalogo = document.getElementById('seccion-catalogo');
            const seccionPropuesta = document.getElementById('seccion-propuesta');
            const seccionInsumos = document.getElementById('seccion-insumos');

            // --- Calculadora de Recetas
            const inputRecetaNombre = document.getElementById('receta-nombre');
            const inputRecetaCaracteristicas = document.getElementById('receta-caracteristicas');
            const inputRecetaCategoria = document.getElementById('receta-categoria');
            const inputRecetaImagen = document.getElementById('receta-imagen');
            const imagenPreview = document.getElementById('imagen-preview');
            const selectorIngrediente = document.getElementById('ingrediente');
            const inputCantidad = document.getElementById('cantidad');
            const btnAgregar = document.getElementById('agregar-btn');
            const listaReceta = document.getElementById('lista-receta');
            const inputGastoDescripcion = document.getElementById('gasto-descripcion');
            const inputGastoMonto = document.getElementById('gasto-monto');
            const btnAgregarGasto = document.getElementById('agregar-gasto-btn');
            const listaGastos = document.getElementById('lista-gastos');
            const inputGastoPerdidaPct = document.getElementById('gasto-perdida-pct');
            const inputGastoProduccionPct = document.getElementById('gasto-produccion-pct');
            const elGastoPerdidaMonto = document.getElementById('gasto-perdida-monto');
            const elGastoProduccionMonto = document.getElementById('gasto-produccion-monto');
            const inputGananciaMinorista = document.getElementById('ganancia-minorista');
            const inputGananciaMayorista = document.getElementById('ganancia-mayorista');
            const elCostoTotalProduccion = document.getElementById('costo-total-produccion');
            const elPrecioFinalMinorista = document.getElementById('precio-final-minorista');
            const elPrecioFinalMayorista = document.getElementById('precio-final-mayorista');
            const btnNuevoRegistro = document.getElementById('nuevo-registro-btn');
            const btnDescargarReporte = document.getElementById('descargar-reporte-btn');
            const btnGuardarCatalogo = document.getElementById('guardar-catalogo-btn');

            // --- Catálogo
            const catalogoContainer = document.getElementById('catalogo-container');
            const catalogoVacioMsg = document.getElementById('catalogo-vacio-msg');
            const filtroCatalogoNombre = document.getElementById('filtro-catalogo-nombre');
            const filtroCatalogoCategoria = document.getElementById('filtro-catalogo-categoria');
            const modalOverlay = document.getElementById('detalle-modal-overlay');
            const modalContent = document.getElementById('detalle-modal-content');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // --- Propuestas
            const inputClienteNombre = document.getElementById('propuesta-cliente-nombre');
            const inputClienteTelefono = document.getElementById('propuesta-cliente-telefono');
            const inputClienteEmail = document.getElementById('propuesta-cliente-email');
            const spanPropuestaNumero = document.getElementById('propuesta-numero');
            const inputPropuestaFecha = document.getElementById('propuesta-fecha');
            const inputPropuestaValidez = document.getElementById('propuesta-validez');
            const selectPropuestaProducto = document.getElementById('propuesta-producto');
            const inputPropuestaCantidad = document.getElementById('propuesta-cantidad');
            const btnPropuestaAgregarProducto = document.getElementById('propuesta-agregar-producto-btn');
            const listaProductosPropuesta = document.getElementById('propuesta-lista-productos');
            const textareaObservaciones = document.getElementById('propuesta-observaciones');
            const canvasFirma = document.getElementById('propuesta-firma-canvas');
            const btnLimpiarFirma = document.getElementById('propuesta-limpiar-firma-btn');
            const inputPropuestaFirmanteNombre = document.getElementById('propuesta-firmante-nombre');
            const inputImpuestoPct = document.getElementById('propuesta-impuesto-pct');
            const elImpuestoResumen = document.getElementById('propuesta-impuesto-resumen');
            const inputDescuento = document.getElementById('propuesta-descuento');
            const inputEnvio = document.getElementById('propuesta-envio');
            const elSubtotalPropuesta = document.getElementById('propuesta-subtotal');
            const elDescuentoResumen = document.getElementById('propuesta-descuento-resumen');
            const elEnvioResumen = document.getElementById('propuesta-envio-resumen');
            const elTotalPropuesta = document.getElementById('propuesta-total');
            const btnLimpiarPropuesta = document.getElementById('propuesta-limpiar-btn');
            const btnGenerarPDFPropuesta = document.getElementById('propuesta-pdf-btn');
            const btnGuardarPropuesta = document.getElementById('propuesta-guardar-btn');
            const btnVerGuardadas = document.getElementById('propuesta-ver-guardadas-btn');
            const listaPropuestasModalOverlay = document.getElementById('lista-propuestas-modal-overlay');
            const listaPropuestasModalCloseBtn = document.getElementById('lista-propuestas-modal-close-btn');
            const tablaPropuestasGuardadas = document.getElementById('tabla-propuestas-guardadas');

            // --- Insumos
            const tablaInsumos = document.getElementById('tabla-insumos');
            const formInsumo = document.getElementById('form-insumo');
            const formInsumoTitulo = document.getElementById('form-insumo-titulo');
            const inputInsumoId = document.getElementById('insumo-id');
            const inputInsumoNombre = document.getElementById('insumo-nombre');
            const inputInsumoPrecio = document.getElementById('insumo-precio');
            const inputInsumoCategoria = document.getElementById('insumo-categoria');
            const btnGuardarInsumo = document.getElementById('btn-guardar-insumo');
            const btnCancelarEdicionInsumo = document.getElementById('btn-cancelar-edicion-insumo');
            const btnCargarExcel = document.getElementById('btn-cargar-excel');
            const inputExcel = document.getElementById('input-excel');
            const btnDescargarDatos = document.getElementById('btn-descargar-datos');
            const filtroInsumoNombre = document.getElementById('filtro-insumo-nombre');
            const filtroInsumoCategoria = document.getElementById('filtro-insumo-categoria');

            // --- Compartir Catálogo
            const shareContainer = document.getElementById('share-container');
            const compartirCatalogoBtn = document.getElementById('compartir-catalogo-btn');
            const mensajeCopiadoSpan = document.getElementById('mensaje-copiado');

            // =================================================================
            // 4. DEFINICIÓN DE FUNCIONES
            // =================================================================

            // --- Funciones de Inicialización y Carga ---
            function inicializarAplicacion() {
                cargarDatosDeUsuario();
            }

            function cargarDatosDeUsuario() {
                if (!currentUser) return;

                const insumosRef = db.collection('usuarios').doc(currentUser.uid).collection('insumos').get();
                const catalogoRef = db.collection('usuarios').doc(currentUser.uid).collection('catalogo').get();
                const propuestasRef = db.collection('usuarios').doc(currentUser.uid).collection('propuestas').get();

                Promise.all([insumosRef, catalogoRef, propuestasRef])
                    .then(([insumosSnapshot, catalogoSnapshot, propuestasSnapshot]) => {
                        if (insumosSnapshot.empty) {
                            alert('No se encontró tu lista de insumos. Creando una lista base ahora.');
                            crearInsumosBaseParaUsuario(currentUser).then(() => window.location.reload());
                            return;
                        }
                        productos = insumosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        catalogo = catalogoSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        propuestasGuardadas = propuestasSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                        // Inicializar y renderizar toda la UI
                        poblarSelectorIngredientes();
                        poblarFiltroCatalogoCategorias();
                        renderizarCatalogo();
                        renderizarReceta();
                        renderizarGastos();
                        poblarFiltroCategorias();
                        filtrarYRenderizarInsumos();
                        inicializarPropuesta();
                        cambiarSeccion('catalogo');
                    })
                    .catch(error => {
                        console.error("Error al cargar datos del usuario: ", error);
                        alert("Hubo un error al cargar tus datos. Por favor, recarga la página.");
                    });
            }
            
            function crearInsumosBaseParaUsuario(user) {
                const insumosBase = [
                    { "nombre": "Cera de soya BPF", "precio_por_gramo": 0.16, "categoria": "Ceras" },
                    { "nombre": "Envase de vidrio B&D 10x9", "precio_por_gramo": 20, "categoria": "Envases" },
                    { "nombre": "Pabilo con alma de algodón A18", "precio_por_gramo": 3.00, "categoria": "Pabilos" },
                    { "nombre": "Fragancia vainilla & caramelo 60 ml", "precio_por_gramo": 2.53, "categoria": "Fragancias" },
                    { "nombre": "Mica café 25 gr", "precio_por_gramo": 3.52, "categoria": "Colorantes" },
                    { "nombre": "Etiqueta personalizada", "precio_por_gramo": 2.00, "categoria": "Decoración" }
                ];

                const insumosRef = db.collection('usuarios').doc(user.uid).collection('insumos');
                const batch = db.batch();

                insumosBase.forEach(insumo => {
                    const docRef = insumosRef.doc();
                    batch.set(docRef, insumo);
                });

                return batch.commit().catch(error => {
                    console.error("Error al crear insumos base para el usuario: ", error);
                });
            }



            // --- Funciones de Navegación y UI General ---
            function cambiarSeccion(seccion) {
                seccionAgregarProducto.classList.add('hidden');
                seccionCatalogo.classList.add('hidden');
                seccionPropuesta.classList.add('hidden');
                seccionInsumos.classList.add('hidden');

                tabAgregarProducto.classList.remove('active');
                tabCatalogo.classList.remove('active');
                tabPropuesta.classList.remove('active');
                tabInsumos.classList.remove('active');

                if (seccion === 'agregar-producto') {
                    seccionAgregarProducto.classList.remove('hidden');
                    tabAgregarProducto.classList.add('active');
                } else if (seccion === 'propuesta') {
                    seccionPropuesta.classList.remove('hidden');
                    tabPropuesta.classList.add('active');
                    poblarSelectorProductosPropuesta();
                } else if (seccion === 'insumos') {
                    seccionInsumos.classList.remove('hidden');
                    tabInsumos.classList.add('active');
                } else { // catalogo por defecto
                    seccionCatalogo.classList.remove('hidden');
                    tabCatalogo.classList.add('active');
                }
            }

            // --- Funciones de la Calculadora ---
            function poblarSelectorIngredientes() {
                 try {
                    const categorias = {};
                    productos.forEach(producto => {
                        if (!categorias[producto.categoria]) {
                            categorias[producto.categoria] = [];
                        }
                        categorias[producto.categoria].push(producto);
                    });
                    selectorIngrediente.innerHTML = '';
                    for (const categoria in categorias) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = categoria;
                        categorias[categoria].sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(producto => {
                            const option = document.createElement('option');
                            option.value = producto.nombre;
                            option.textContent = `${producto.nombre} (${producto.precio_por_gramo.toFixed(2)} por g/ml/pz)`;
                            optgroup.appendChild(option);
                        });
                        selectorIngrediente.appendChild(optgroup);
                    }
                } catch (error) {
                    console.error('Error al inicializar selector de ingredientes:', error);
                }
            }

            function renderizarReceta() {
                listaReceta.innerHTML = '';
                const baseCera = receta.find(item => item.nombre.toLowerCase().includes("cera"));
                const cantidadBase = baseCera ? baseCera.cantidad : 0;

                if (receta.length === 0) {
                    listaReceta.innerHTML = `<tr id="fila-vacia-receta"><td colspan="5" class="px-6 py-4 text-center text-gray-500">Aún no has agregado ingredientes.</td></tr>`;
                } else {
                    receta.forEach((item, index) => {
                        const tr = document.createElement('tr');
                        let porcentajeContenido = (item.nombre.toLowerCase().includes("cera")) ? `<div class="text-sm font-semibold text-indigo-600">Base</div>`
                            : (cantidadBase > 0) ? `<div class="text-sm text-gray-700">${((item.cantidad / cantidadBase) * 100).toFixed(2)}%</div>`
                            : `<div class="text-sm text-gray-500">N/A</div>`;
                        
                        tr.innerHTML = `
                            <td class="px-4 py-2"><div class="text-sm font-medium text-gray-900">${item.nombre}</div></td>
                            <td class="px-4 py-2"><div class="text-sm text-gray-700">${item.cantidad} g/ml/pz</div></td>
                            <td class="px-4 py-2">${porcentajeContenido}</td>
                            <td class="px-4 py-2"><div class="text-sm text-gray-700">$${item.costo.toFixed(2)}</div></td>
                            <td class="px-4 py-2 text-right"><button class="btn-danger btn-sm" data-index="${index}">X</button></td>`;
                        listaReceta.appendChild(tr);
                    });
                }
                calcularTotales();
            }

            function renderizarGastos() {
                listaGastos.innerHTML = '';
                if (gastosAdicionales.length === 0) {
                    listaGastos.innerHTML = `<tr id="fila-vacia-gastos"><td colspan="3" class="px-6 py-4 text-center text-gray-500">Aún no has agregado gastos.</td></tr>`;
                } else {
                    gastosAdicionales.forEach((gasto, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="px-4 py-2"><div class="text-sm font-medium text-gray-900">${gasto.descripcion}</div></td>
                            <td class="px-4 py-2"><div class="text-sm text-gray-700">$${gasto.monto.toFixed(2)}</div></td>
                            <td class="px-4 py-2 text-right"><button class="btn-danger btn-sm" data-index="${index}">X</button></td>`;
                        listaGastos.appendChild(tr);
                    });
                }
                calcularTotales();
            }
            
            function calcularTotales() {
                const costoIngredientes = receta.reduce((total, item) => total + item.costo, 0);
                const costoGastosManuales = gastosAdicionales.reduce((total, gasto) => total + gasto.monto, 0);

                const pctPerdida = parseFloat(inputGastoPerdidaPct.value) || 0;
                const pctProduccion = parseFloat(inputGastoProduccionPct.value) || 0;
                const sumaPorcentajes = (pctPerdida + pctProduccion) / 100;

                const costoBaseParaCalculo = costoIngredientes + costoGastosManuales;
                const costoTotalProduccion = (sumaPorcentajes < 1) ? costoBaseParaCalculo / (1 - sumaPorcentajes) : costoBaseParaCalculo;

                const montoPerdida = costoTotalProduccion * (pctPerdida / 100);
                const montoProduccion = costoTotalProduccion * (pctProduccion / 100);

                elGastoPerdidaMonto.textContent = `$${montoPerdida.toFixed(2)}`;
                elGastoProduccionMonto.textContent = `$${montoProduccion.toFixed(2)}`;

                elCostoTotalProduccion.textContent = `$${costoTotalProduccion.toFixed(2)}`;

                const margenMinorista = parseFloat(inputGananciaMinorista.value) || 0;
                let precioVentaMinorista = costoTotalProduccion * (1 + margenMinorista / 100);
                precioVentaMinorista = Math.ceil(precioVentaMinorista);
                elPrecioFinalMinorista.textContent = `$${precioVentaMinorista.toFixed(2)}`;

                const margenMayorista = parseFloat(inputGananciaMayorista.value) || 0;
                let precioVentaMayorista = costoTotalProduccion * (1 + margenMayorista / 100);
                precioVentaMayorista = Math.ceil(precioVentaMayorista);
                elPrecioFinalMayorista.textContent = `$${precioVentaMayorista.toFixed(2)}`;
            }

            // --- Funciones del Catálogo ---
            function poblarFiltroCatalogoCategorias() {
                const categorias = [...new Set(
                    catalogo.flatMap(p => {
                        if (Array.isArray(p.categoria)) {
                            return p.categoria;
                        }
                        if (typeof p.categoria === 'string' && p.categoria) {
                            return [p.categoria]; // Handle old string-based categories
                        }
                        return [];
                    })
                )].sort();
                filtroCatalogoCategoria.innerHTML = '<option value="">Todas las categorías</option>';
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    filtroCatalogoCategoria.appendChild(option);
                });
            }

            async function guardarEnCatalogo() {
                btnGuardarCatalogo.disabled = true;
                btnGuardarCatalogo.textContent = 'Guardando...';

                try {
                    if (!currentUser) {
                        alert('Debes iniciar sesión para guardar en el catálogo.');
                        return;
                    }
                    
                    const nombre = inputRecetaNombre.value.trim();
                    if (!nombre) {
                        alert('Por favor, asigna un nombre a la receta antes de guardarla.');
                        return;
                    }
                    if (receta.length === 0) {
                        alert('No puedes guardar una receta vacía.');
                        return;
                    }

                    const imagenUrls = [];
                    for (let i = 1; i <= 4; i++) {
                        const fileInput = document.getElementById(`receta-imagen-${i}`);
                        const file = fileInput.files[0];
                        if (file) {
                            const filePath = `usuarios/${currentUser.uid}/catalogo_imagenes/${Date.now()}_${file.name}`;
                            const fileRef = storage.ref(filePath);
                            await fileRef.put(file);
                            const url = await fileRef.getDownloadURL();
                            imagenUrls.push(url);
                        }
                    }

                    const categorias = inputRecetaCategoria.value.split(',').map(c => c.trim()).filter(c => c);
                    const nuevaVela = {
                        nombre: nombre,
                        caracteristicas: inputRecetaCaracteristicas.value.trim(),
                        categoria: categorias,
                        receta: [...receta],
                        gastosAdicionales: [...gastosAdicionales],
                        pctGastoPerdida: parseFloat(inputGastoPerdidaPct.value) || 0,
                        pctGastoProduccion: parseFloat(inputGastoProduccionPct.value) || 0,
                        margenGananciaMinorista: parseFloat(inputGananciaMinorista.value) || 0,
                        margenGananciaMayorista: parseFloat(inputGananciaMayorista.value) || 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        imagenUrls: imagenUrls
                    };

                    const docRef = await db.collection('usuarios').doc(currentUser.uid).collection('catalogo').add(nuevaVela);
                    
                    catalogo.push({ id: docRef.id, ...nuevaVela });
                    poblarFiltroCatalogoCategorias();
                    renderizarCatalogo();
                    alert(`'${nombre}' se ha guardado en el catálogo.`);
                    cambiarSeccion('catalogo');

                } catch (error) {
                    console.error("Error al guardar en catálogo: ", error);
                    alert("Hubo un error al guardar la vela. Revisa la consola para más detalles.");
                } finally {
                    btnGuardarCatalogo.disabled = false;
                    btnGuardarCatalogo.textContent = 'Guardar en Catálogo';
                }
            }

            function renderizarCatalogo() {
                catalogoContainer.innerHTML = '';

                const textoBusqueda = filtroCatalogoNombre.value.toLowerCase();
                const categoriaSeleccionada = filtroCatalogoCategoria.value;

                const catalogoFiltrado = catalogo.filter(vela => {
                    const matchNombre = !textoBusqueda || vela.nombre.toLowerCase().includes(textoBusqueda);
                    
                    let matchCategoria = !categoriaSeleccionada;
                    if (vela.categoria && categoriaSeleccionada) {
                        if (Array.isArray(vela.categoria)) {
                            matchCategoria = vela.categoria.includes(categoriaSeleccionada);
                        } else if (typeof vela.categoria === 'string') { // For backwards compatibility
                            matchCategoria = vela.categoria === categoriaSeleccionada;
                        }
                    }

                    return matchNombre && matchCategoria;
                });

                if (catalogoFiltrado.length === 0) {
                    catalogoVacioMsg.textContent = catalogo.length === 0 ? 'El catálogo está vacío. Guarda una receta para empezar.' : 'No se encontraron productos con los filtros actuales.';
                    catalogoVacioMsg.style.display = 'block';
                    // Do not append, it's already in the DOM
                    renderizarPaginacion(catalogoFiltrado);
                    return;
                }
                
                catalogoVacioMsg.style.display = 'none';

                const inicio = (paginaActualCatalogo - 1) * itemsPorPagina;
                const fin = inicio + itemsPorPagina;
                const itemsPagina = catalogoFiltrado.slice(inicio, fin);

                itemsPagina.forEach(vela => {
                    const card = document.createElement('div');
                    card.className = 'card flex flex-col';

                    const costoTotal = calcularCostoTotalVela(vela);
                    const precioVentaMinorista = costoTotal * (1 + (vela.margenGananciaMinorista || 0) / 100);
                    const precioVentaMayorista = costoTotal * (1 + (vela.margenGananciaMayorista || 0) / 100);

                    const imagenHtml = vela.imagenUrls && vela.imagenUrls.length > 0
                        ? `<img src="${vela.imagenUrls[0]}" alt="${vela.nombre}" class="w-full h-48 object-cover rounded-t-lg mb-4">`
                        : '<div class="w-full h-48 bg-gray-200 rounded-t-lg flex items-center justify-center mb-4"><span class="text-gray-500 text-sm">Sin imagen</span></div>';

                    const categoriasHtml = Array.isArray(vela.categoria) && vela.categoria.length > 0
                        ? `<div class="flex flex-wrap gap-1 mt-2">${vela.categoria.map(c => `<span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${c}</span>`).join('')}</div>`
                        : (typeof vela.categoria === 'string' && vela.categoria) 
                            ? `<div class="flex flex-wrap gap-1 mt-2"><span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${vela.categoria}</span></div>`
                            : '';

                    card.innerHTML = `
                        ${imagenHtml}
                        <div class="p-4 flex-grow flex flex-col">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-lg font-bold text-gray-800">${vela.nombre}</h3>
                                <button class="btn-danger btn-sm btn-borrar flex-shrink-0" data-id="${vela.id}">X</button>
                            </div>
                            <p class="text-sm text-gray-500 mb-3 flex-grow">${vela.caracteristicas || ''}</p>
                            ${categoriasHtml}
                            <div class="space-y-2 mt-auto pt-3">
                                <div class="flex justify-between text-sm"><span>Costo:</span><span class="font-medium">$${costoTotal.toFixed(2)}</span></div>
                                <div class="flex justify-between text-lg font-bold text-indigo-600 mt-2 pt-2 border-t"><span>Minorista:</span><span>$${precioVentaMinorista.toFixed(2)}</span></div>
                                <div class="flex justify-between text-lg font-bold text-teal-600"><span>Mayorista:</span><span>$${precioVentaMayorista.toFixed(2)}</span></div>
                            </div>
                            <div class="text-center mt-4"><button class="text-indigo-600 hover:text-indigo-800 font-semibold text-sm btn-ver-detalles" data-id="${vela.id}">Ver Detalles</button></div>
                        </div>
                    `;
                    catalogoContainer.appendChild(card);
                });

                renderizarPaginacion(catalogoFiltrado);
            }

            function renderizarPaginacion(items) {
                const paginacionContainer = document.getElementById('catalogo-paginacion');
                paginacionContainer.innerHTML = '';
                const totalPaginas = Math.ceil(items.length / itemsPorPagina);

                if (totalPaginas <= 1) return;

                const btnAnterior = document.createElement('button');
                btnAnterior.textContent = 'Anterior';
                btnAnterior.className = 'btn-neutral';
                btnAnterior.disabled = paginaActualCatalogo === 1;
                btnAnterior.addEventListener('click', () => {
                    if (paginaActualCatalogo > 1) {
                        paginaActualCatalogo--;
                        renderizarCatalogo();
                    }
                });
                paginacionContainer.appendChild(btnAnterior);

                const indicadorPagina = document.createElement('span');
                indicadorPagina.className = 'text-lg font-medium';
                indicadorPagina.textContent = `Página ${paginaActualCatalogo} de ${totalPaginas}`;
                paginacionContainer.appendChild(indicadorPagina);

                const btnSiguiente = document.createElement('button');
                btnSiguiente.textContent = 'Siguiente';
                btnSiguiente.className = 'btn-neutral';
                btnSiguiente.disabled = paginaActualCatalogo === totalPaginas;
                btnSiguiente.addEventListener('click', () => {
                    if (paginaActualCatalogo < totalPaginas) {
                        paginaActualCatalogo++;
                        renderizarCatalogo();
                    }
                });
                paginacionContainer.appendChild(btnSiguiente);
            }

            function borrarDelCatalogo(id) {
                if (!currentUser) return;
                const velaIndex = catalogo.findIndex(v => v.id === id);
                if (velaIndex > -1) {
                    const vela = catalogo[velaIndex];
                    if (confirm(`¿Estás seguro de que quieres eliminar '${vela.nombre}' del catálogo?`)) {
                        const deletePromise = db.collection('usuarios').doc(currentUser.uid).collection('catalogo').doc(id).delete();
                        const imageDeletePromise = vela.imagenUrl ? storage.refFromURL(vela.imagenUrl).delete() : Promise.resolve();

                        Promise.all([deletePromise, imageDeletePromise])
                            .then(() => {
                                catalogo.splice(velaIndex, 1);
                                poblarFiltroCatalogoCategorias();
                                renderizarCatalogo();
                            })
                            .catch(error => {
                                console.error("Error al eliminar del catálogo: ", error);
                                alert("Hubo un error al eliminar la vela. Es posible que la imagen no se haya borrado si el producto ya no existía.");
                            });
                    }
                }
            }

            function mostrarDetalles(id) {
                const vela = catalogo.find(v => v.id === id);
                if (!vela) return;

                let imagesHtml = '';
                for (let i = 0; i < 4; i++) {
                    const imageUrl = vela.imagenUrls && vela.imagenUrls[i] ? vela.imagenUrls[i] : '';
                    imagesHtml += `
                        <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                            <input type="file" id="modal-receta-imagen-${i + 1}" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*" data-index="${i + 1}">
                            <img id="modal-imagen-preview-${i + 1}" src="${imageUrl}" alt="Vista previa ${i + 1}" class="absolute inset-0 w-full h-full object-cover rounded-lg ${imageUrl ? '' : 'hidden'}">
                            <div id="modal-placeholder-${i + 1}" class="text-gray-500 ${imageUrl ? 'hidden' : ''}">
                                <svg class="mx-auto h-12 w-12" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 0 0-4 4v20m32-12v8m0 0v8a4 4 0 0 1-4 4H12a4 4 0 0 1-4-4v-4m32-4l-3.172-3.172a4 4 0 0 0-5.656 0L28 28M8 32l9.172-9.172a4 4 0 0 1 5.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                <p class="mt-1 text-sm">Click para subir</p>
                            </div>
                            ${imageUrl ? `<button class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 leading-none btn-eliminar-imagen-modal" data-vela-id="${id}" data-image-url="${imageUrl}" data-index="${i}">&times;</button>` : ''}
                        </div>
                    `;
                }

                let recetaHtml = vela.receta.map((item, index) => `<tr><td class="px-4 py-2">${item.nombre}</td><td class="px-4 py-2"><input type="number" value="${item.cantidad}" class="input-field w-24" data-receta-index="${index}"></td><td class="px-4 py-2">$${item.costo.toFixed(2)}</td></tr>`).join('');
                let gastosHtml = vela.gastosAdicionales.map((gasto, index) => `<tr><td class="px-4 py-2"><input type="text" value="${gasto.descripcion}" class="input-field w-full" data-gasto-desc-index="${index}"></td><td class="px-4 py-2"><input type="number" value="${gasto.monto}" class="input-field w-24" data-gasto-monto-index="${index}"></td></tr>`).join('');
                const costoTotal = calcularCostoTotalVela(vela);
                const precioVentaMinorista = costoTotal * (1 + (vela.margenGananciaMinorista || 0) / 100);
                const precioVentaMayorista = costoTotal * (1 + (vela.margenGananciaMayorista || 0) / 100);
                const categoriasStr = Array.isArray(vela.categoria) ? vela.categoria.join(', ') : (vela.categoria || '');

                modalContent.innerHTML = `
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fotos del Producto</label>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            ${imagesHtml}
                        </div>
                    </div>
                    <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto</label><input type="text" id="modal-nombre-producto" class="input-field w-full text-2xl font-bold" value="${vela.nombre}"></div>
                    <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Características</label><textarea id="modal-caracteristicas" class="input-field w-full" rows="2">${vela.caracteristicas || ''}</textarea></div>
                    <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Categorías (separadas por coma)</label><input type="text" id="modal-categoria" class="input-field w-full" value="${categoriasStr}"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div><label for="modal-gasto-perdida-pct" class="block text-sm font-medium text-gray-700">Costos por perdida (%)</label><input type="number" id="modal-gasto-perdida-pct" value="${vela.pctGastoPerdida || 0}" class="input-field mt-1"></div>
                        <div><label for="modal-gasto-produccion-pct" class="block text-sm font-medium text-gray-700">Costos de produccion (%)</label><input type="number" id="modal-gasto-produccion-pct" value="${vela.pctGastoProduccion || 0}" class="input-field mt-1"></div>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">Receta</h3>
                    <table class="min-w-full divide-y divide-gray-200 mb-6"><thead class="table-header"><tr><th class="px-4 py-2 text-left">Ingrediente</th><th class="px-4 py-2 text-left">Cantidad</th><th class="px-4 py-2 text-left">Costo</th></tr></thead><tbody id="modal-lista-receta" class="bg-white divide-y divide-gray-200">${recetaHtml}</tbody></table>
                    <h3 class="text-lg font-semibold mb-2">Gastos Manuales</h3>
                    <table class="min-w-full divide-y divide-gray-200 mb-6"><thead class="table-header"><tr><th class="px-4 py-2 text-left">Descripción</th><th class="px-4 py-2 text-left">Monto</th></tr></thead><tbody id="modal-lista-gastos" class="bg-white divide-y divide-gray-200">${gastosHtml}</tbody></table>
                    <h3 class="text-lg font-semibold mb-2">Resumen de Precio</h3>
                    <div class="summary-card space-y-3">
                        <div class="flex justify-between text-sm"><span>Costo Total Producción:</span><span class="font-medium">$${costoTotal.toFixed(2)}</span></div>
                        <div class="border-t"></div>
                        <div class="flex justify-between text-lg mt-3"><span>Margen Minorista:</span><span class="font-medium">${vela.margenGananciaMinorista}%</span></div>
                        <div class="flex justify-between text-xl font-bold text-indigo-600"><span>Precio Venta Minorista:</span><span>$${precioVentaMinorista.toFixed(2)}</span></div>
                        <div class="border-t mt-3"></div>
                        <div class="flex justify-between text-lg mt-3"><span>Margen Mayorista:</span><span class="font-medium">${vela.margenGananciaMayorista}%</span></div>
                        <div class="flex justify-between text-xl font-bold text-teal-600"><span>Precio Venta Mayorista:</span><span>$${precioVentaMayorista.toFixed(2)}</span></div>
                    </div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button class="btn-neutral btn-cancelar-modal">Cancelar</button>
                        <button class="btn-primary btn-guardar-cambios" data-id="${vela.id}">Guardar Cambios</button>
                    </div>

                `;
                modalOverlay.classList.remove('hidden');

                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`modal-receta-imagen-${i}`).addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        const preview = document.getElementById(`modal-imagen-preview-${i}`);
                        const placeholder = document.getElementById(`modal-placeholder-${i}`);
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                preview.src = event.target.result;
                                preview.classList.remove('hidden');
                                placeholder.classList.add('hidden');
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            }

            async function guardarCambios(id) {
                if (!currentUser) return;
                const velaIndex = catalogo.findIndex(v => v.id === id);
                if (velaIndex === -1) return;

                const btnGuardar = document.querySelector('.btn-guardar-cambios');
                btnGuardar.disabled = true;
                btnGuardar.textContent = 'Guardando...';

                try {
                    const velaOriginal = catalogo[velaIndex];
                    const velaActualizada = { ...velaOriginal };

                    const newImageUrls = [...(velaOriginal.imagenUrls || [])];

                    for (let i = 1; i <= 4; i++) {
                        const fileInput = document.getElementById(`modal-receta-imagen-${i}`);
                        const file = fileInput.files[0];

                        if (file) {
                            // If there was an old image at this position, delete it
                            if (velaOriginal.imagenUrls && velaOriginal.imagenUrls[i - 1]) {
                                try {
                                    await storage.refFromURL(velaOriginal.imagenUrls[i - 1]).delete();
                                } catch (imgError) {
                                    console.warn(`No se pudo borrar la imagen anterior en la posición ${i}:`, imgError);
                                }
                            }

                            // Upload new image
                            const filePath = `usuarios/${currentUser.uid}/catalogo_imagenes/${Date.now()}_${file.name}`;
                            const fileRef = storage.ref(filePath);
                            await fileRef.put(file);
                            newImageUrls[i - 1] = await fileRef.getDownloadURL();
                        }
                    }
                    velaActualizada.imagenUrls = newImageUrls.filter(url => url); // Remove any empty spots

                    velaActualizada.nombre = document.getElementById('modal-nombre-producto').value.trim();
                    velaActualizada.caracteristicas = document.getElementById('modal-caracteristicas').value.trim();
                    const categoriasInput = document.getElementById('modal-categoria').value;
                    velaActualizada.categoria = categoriasInput.split(',').map(c => c.trim()).filter(c => c);
                    velaActualizada.pctGastoPerdida = parseFloat(document.getElementById('modal-gasto-perdida-pct').value) || 0;
                    velaActualizada.pctGastoProduccion = parseFloat(document.getElementById('modal-gasto-produccion-pct').value) || 0;

                    const nuevosReceta = [];
                    document.querySelectorAll('[data-receta-index]').forEach(input => {
                        const index = parseInt(input.dataset.recetaIndex, 10);
                        const nuevaCantidad = parseFloat(input.value);
                        const itemOriginal = velaOriginal.receta[index];
                        const producto = productos.find(p => p.nombre === itemOriginal.nombre);
                        
                        if (producto && nuevaCantidad > 0) {
                            nuevosReceta.push({ nombre: itemOriginal.nombre, cantidad: nuevaCantidad, costo: producto.precio_por_gramo * nuevaCantidad });
                        }
                    });
                    velaActualizada.receta = nuevosReceta;

                    const nuevosGastos = [];
                    document.querySelectorAll('[data-gasto-desc-index]').forEach((inputDesc, i) => {
                        const inputMonto = document.querySelector(`[data-gasto-monto-index="${i}"]`);
                        const nuevaDescripcion = inputDesc.value.trim();
                        const nuevoMonto = parseFloat(inputMonto.value);

                        if (nuevaDescripcion && nuevoMonto > 0) {
                            nuevosGastos.push({ descripcion: nuevaDescripcion, monto: nuevoMonto });
                        }
                    });
                    velaActualizada.gastosAdicionales = nuevosGastos;

                    await db.collection('usuarios').doc(currentUser.uid).collection('catalogo').doc(id).update(velaActualizada);
                    
                    catalogo[velaIndex] = { id, ...velaActualizada };
                    poblarFiltroCatalogoCategorias();
                    renderizarCatalogo();
                    modalOverlay.classList.add('hidden');
                    alert('¡Cambios guardados con éxito!');

                } catch (error) {
                    console.error("Error al guardar cambios: ", error);
                    alert("Hubo un error al guardar los cambios.");
                } finally {
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'Guardar Cambios';
                }
            }

            function calcularCostoTotalVela(vela) {
                const costoIngredientes = vela.receta.reduce((total, item) => total + item.costo, 0);
                const costoGastosManuales = vela.gastosAdicionales.reduce((total, gasto) => total + gasto.monto, 0);
                const pctPerdida = vela.pctGastoPerdida || 0;
                const pctProduccion = vela.pctGastoProduccion || 0;
                const sumaPorcentajes = (pctPerdida + pctProduccion) / 100;
                const costoBase = costoIngredientes + costoGastosManuales;
                return (sumaPorcentajes < 1) ? costoBase / (1 - sumaPorcentajes) : costoBase;
            }

            async function borrarImagenDeVela(velaId, imageUrl, index) {
                if (!currentUser) return;

                const confirmarBorradoModal = document.getElementById('confirmar-borrado-modal-overlay');
                const btnConfirmar = document.getElementById('btn-confirmar-borrado');
                btnConfirmar.disabled = true;
                btnConfirmar.textContent = 'Eliminando...';

                try {
                    // 1. Borrar de Firebase Storage
                    if (imageUrl.startsWith('https://firebasestorage.googleapis.com')) {
                        await storage.refFromURL(imageUrl).delete();
                    }

                    // 2. Actualizar el array en Firestore
                    const velaRef = db.collection('usuarios').doc(currentUser.uid).collection('catalogo').doc(velaId);
                    
                    // Usamos un valor especial para eliminar el elemento del array
                    const updatePayload = {};
                    updatePayload[`imagenUrls.${index}`] = firebase.firestore.FieldValue.delete();
                    await velaRef.update(updatePayload);

                    // For a more robust solution that handles shifting array elements, we can do a transaction
                    await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(velaRef);
                        if (!doc.exists) { throw "Document does not exist!"; }
                        
                        const originalUrls = doc.data().imagenUrls || [];
                        const newUrls = originalUrls.filter(url => url !== imageUrl);
                        
                        transaction.update(velaRef, { imagenUrls: newUrls });
                    });


                    // 3. Actualizar UI
                    const preview = document.getElementById(`modal-imagen-preview-${parseInt(index) + 1}`);
                    const placeholder = document.getElementById(`modal-placeholder-${parseInt(index) + 1}`);
                    preview.src = '';
                    preview.classList.add('hidden');
                    placeholder.classList.remove('hidden');

                    // 4. Actualizar datos locales y renderizar
                    const velaLocalIndex = catalogo.findIndex(v => v.id === velaId);
                    if (velaLocalIndex > -1) {
                        catalogo[velaLocalIndex].imagenUrls = catalogo[velaLocalIndex].imagenUrls.filter(url => url !== imageUrl);
                    }
                    renderizarCatalogo();

                    alert('Imagen eliminada con éxito.');

                } catch (error) {
                    console.error("Error al eliminar imagen: ", error);
                    alert("Hubo un error al eliminar la imagen.");
                } finally {
                    confirmarBorradoModal.classList.add('hidden');
                    btnConfirmar.disabled = false;
                    btnConfirmar.textContent = 'Confirmar';
                }
            }

            // --- Funciones de Propuestas ---
            function inicializarPropuesta() {
                actualizarNumeroPropuesta();
                const ctx = canvasFirma.getContext('2d');
                let dibujando = false;

                function iniciarDibujo(e) { dibujando = true; dibujar(e); }
                function finalizarDibujo() { dibujando = false; ctx.beginPath(); }
                function dibujar(e) {
                    if (!dibujando) return;
                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';
                    const rect = canvasFirma.getBoundingClientRect();
                    const x = (e.clientX || e.touches[0].clientX) - rect.left;
                    const y = (e.clientY || e.touches[0].clientY) - rect.top;
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                }

                canvasFirma.addEventListener('mousedown', iniciarDibujo);
                canvasFirma.addEventListener('mouseup', finalizarDibujo);
                canvasFirma.addEventListener('mousemove', dibujar);
                canvasFirma.addEventListener('touchstart', iniciarDibujo);
                canvasFirma.addEventListener('touchend', finalizarDibujo);
                canvasFirma.addEventListener('touchmove', dibujar);

                const hoy = new Date();
                const opcionesFecha = { year: 'numeric', month: 'long', day: 'numeric' };
                inputPropuestaFecha.value = hoy.toLocaleDateString('es-ES', opcionesFecha);
                const unaSemanaDespues = new Date();
                unaSemanaDespues.setDate(unaSemanaDespues.getDate() + 7);
                inputPropuestaValidez.value = unaSemanaDespues.toLocaleDateString('es-ES', opcionesFecha);
            }

            function poblarSelectorProductosPropuesta() {
                selectPropuestaProducto.innerHTML = '<option value="">Seleccione un producto...</option>';
                catalogo.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(vela => {
                    const option = document.createElement('option');
                    option.value = vela.id;
                    option.textContent = vela.nombre;
                    selectPropuestaProducto.appendChild(option);
                });
            }

            function calcularPrecioVela(vela) {
                const costoTotal = calcularCostoTotalVela(vela);
                return costoTotal * (1 + (vela.margenGananciaMinorista || 0) / 100);
            }

            function agregarProductoAPropuesta() {
                const productoId = selectPropuestaProducto.value;
                const cantidad = parseInt(inputPropuestaCantidad.value, 10) || 1;
                if (!productoId) return;

                const vela = catalogo.find(v => v.id === productoId);
                if (!vela) return;

                const tipoPrecio = document.querySelector('input[name="tipo-precio-propuesta"]:checked').value;
                const costoTotal = calcularCostoTotalVela(vela);
                let precioUnitario;

                if (tipoPrecio === 'mayorista') {
                    precioUnitario = costoTotal * (1 + (vela.margenGananciaMayorista || 0) / 100);
                } else { // minorista por defecto
                    precioUnitario = costoTotal * (1 + (vela.margenGananciaMinorista || 0) / 100);
                }

                propuestaActual.pedido.push({
                    id: vela.id,
                    nombre: vela.nombre,
                    cantidad: cantidad,
                    precioUnitario: precioUnitario,
                    total: cantidad * precioUnitario
                });

                inputPropuestaCantidad.value = '1';
                renderizarPedidoPropuesta();
            }

            function renderizarPedidoPropuesta() {
                listaProductosPropuesta.innerHTML = '';
                if (propuestaActual.pedido.length === 0) {
                    listaProductosPropuesta.innerHTML = `<tr id="propuesta-fila-vacia"><td colspan="5" class="px-6 py-4 text-center text-gray-500">Aún no has agregado productos.</td></tr>`;
                } else {
                    propuestaActual.pedido.forEach((producto, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="px-4 py-2">${producto.nombre}</td>
                            <td class="px-4 py-2">${producto.cantidad}</td>
                            <td class="px-4 py-2">$${producto.precioUnitario.toFixed(2)}</td>
                            <td class="px-4 py-2">$${producto.total.toFixed(2)}</td>
                            <td class="px-4 py-2 text-right"><button class="btn-danger btn-sm btn-eliminar-producto-propuesta" data-index="${index}">X</button></td>
                        `;
                        listaProductosPropuesta.appendChild(tr);
                    });
                }
                calcularTotalesPropuesta();
            }

            function calcularTotalesPropuesta() {
                const subtotal = propuestaActual.pedido.reduce((total, p) => total + p.total, 0);
                const impuestoPct = parseFloat(inputImpuestoPct.value) || 0;
                const descuento = parseFloat(inputDescuento.value) || 0;
                const envio = parseFloat(inputEnvio.value) || 0;

                const montoImpuesto = subtotal * (impuestoPct / 100);
                const total = subtotal + montoImpuesto - descuento + envio;

                elSubtotalPropuesta.textContent = `$${subtotal.toFixed(2)}`;
                elImpuestoResumen.textContent = `$${montoImpuesto.toFixed(2)}`;
                elDescuentoResumen.textContent = `-$${descuento.toFixed(2)}`;
                elEnvioResumen.textContent = `$${envio.toFixed(2)}`;
                elTotalPropuesta.textContent = `$${total.toFixed(2)}`;
            }

            function limpiarPropuesta() {
                propuestaActual = { cliente: {}, detalles: {}, pedido: [], costos: {} };
                inputClienteNombre.value = '';
                inputClienteTelefono.value = '';
                inputClienteEmail.value = '';
                inputPropuestaCantidad.value = '1';
                textareaObservaciones.value = '';
                inputPropuestaFirmanteNombre.value = '';
                inputImpuestoPct.value = '16';
                inputDescuento.value = '0';
                inputEnvio.value = '0';
                const ctx = canvasFirma.getContext('2d');
                ctx.clearRect(0, 0, canvasFirma.width, canvasFirma.height);
                renderizarPedidoPropuesta();
                actualizarNumeroPropuesta();
            }

            function guardarPropuesta() {
                if (!currentUser) return alert('Debes iniciar sesión para guardar.');

                const propuesta = {
                    numero: spanPropuestaNumero.textContent,
                    fecha: inputPropuestaFecha.value,
                    validez: inputPropuestaValidez.value,
                    cliente: { nombre: inputClienteNombre.value, telefono: inputClienteTelefono.value, email: inputClienteEmail.value },
                    pedido: [...propuestaActual.pedido],
                    observaciones: textareaObservaciones.value,
                    firmante: inputPropuestaFirmanteNombre.value,
                    costos: { impuestoPct: parseFloat(inputImpuestoPct.value) || 0, montoImpuesto: parseFloat(elImpuestoResumen.textContent.replace('$', '')), descuento: parseFloat(inputDescuento.value) || 0, envio: parseFloat(inputEnvio.value) || 0, subtotal: parseFloat(elSubtotalPropuesta.textContent.replace('$', '')), total: parseFloat(elTotalPropuesta.textContent.replace('$', '')) },
                    firmaDataUrl: canvasFirma.toDataURL(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                db.collection('usuarios').doc(currentUser.uid).collection('propuestas').add(propuesta)
                    .then(docRef => {
                        propuestasGuardadas.push({ id: docRef.id, ...propuesta });
                        alert(`La propuesta ${propuesta.numero} ha sido guardada.`);
                        limpiarPropuesta();
                    })
                    .catch(error => {
                        console.error("Error al guardar propuesta: ", error);
                        alert("Hubo un error al guardar la propuesta.");
                    });
            }

            function actualizarNumeroPropuesta() {
                const ultimoNumero = propuestasGuardadas.reduce((max, p) => {
                    const num = parseInt(p.numero.replace('#', ''), 10);
                    return num > max ? num : max;
                }, 0);
                spanPropuestaNumero.textContent = `#${(ultimoNumero + 1).toString().padStart(4, '0')}`;
            }

            function renderizarListaPropuestas() {
                tablaPropuestasGuardadas.innerHTML = '';
                if (propuestasGuardadas.length === 0) {
                    tablaPropuestasGuardadas.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No hay propuestas guardadas.</td></tr>`;
                    return;
                }

                propuestasGuardadas.sort((a, b) => b.createdAt.seconds - a.createdAt.seconds).forEach(propuesta => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-2 font-medium">${propuesta.numero}</td>
                        <td class="px-4 py-2">${propuesta.cliente.nombre}</td>
                        <td class="px-4 py-2">${propuesta.fecha}</td>
                        <td class="px-4 py-2 font-semibold">$${propuesta.costos.total.toFixed(2)}</td>
                        <td class="px-4 py-2 text-right">
                            <button class="btn-secondary btn-xs btn-ver-propuesta" data-id="${propuesta.id}">Ver</button>
                            <button class="btn-danger btn-xs btn-eliminar-propuesta ml-1" data-id="${propuesta.id}">Eliminar</button>
                        </td>
                    `;
                    tablaPropuestasGuardadas.appendChild(tr);
                });
            }

            function cargarPropuesta(id) {
                const propuesta = propuestasGuardadas.find(p => p.id === id);
                if (!propuesta) return;

                limpiarPropuesta();

                spanPropuestaNumero.textContent = propuesta.numero;
                inputPropuestaFecha.value = propuesta.fecha;
                inputPropuestaValidez.value = propuesta.validez;
                inputClienteNombre.value = propuesta.cliente.nombre;
                inputClienteTelefono.value = propuesta.cliente.telefono;
                inputClienteEmail.value = propuesta.cliente.email;
                propuestaActual.pedido = [...propuesta.pedido];
                textareaObservaciones.value = propuesta.observaciones;
                inputPropuestaFirmanteNombre.value = propuesta.firmante;
                inputImpuestoPct.value = propuesta.costos.impuestoPct !== undefined ? propuesta.costos.impuestoPct : 16;
                inputDescuento.value = propuesta.costos.descuento;
                inputEnvio.value = propuesta.costos.envio;

                const ctx = canvasFirma.getContext('2d');
                if (propuesta.firmaDataUrl) {
                    const img = new Image();
                    img.onload = function() { ctx.drawImage(img, 0, 0); };
                    img.src = propuesta.firmaDataUrl;
                }

                renderizarPedidoPropuesta();
            }

            function eliminarPropuesta(id) {
                if (!currentUser) return;
                const index = propuestasGuardadas.findIndex(p => p.id === id);
                if (index > -1) {
                    if (confirm(`¿Estás seguro de que quieres eliminar la propuesta #${propuestasGuardadas[index].numero}?`)) {
                        db.collection('usuarios').doc(currentUser.uid).collection('propuestas').doc(id).delete()
                            .then(() => {
                                propuestasGuardadas.splice(index, 1);
                                renderizarListaPropuestas();
                            })
                            .catch(error => {
                                console.error("Error al eliminar propuesta: ", error);
                                alert("Hubo un error al eliminar la propuesta.");
                            });
                    }
                }
            }

            function generarPDFPropuesta() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
            }


            // --- Funciones de Gestión de Insumos ---
            function cargarInsumosDesdeExcel(file) {
                if (!file) return;
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        // Use { header: 1 } to get an array of arrays, which is more robust.
                        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        if (rows.length < 2) { // At least one header and one data row
                            alert('El archivo de Excel está vacío o no contiene datos.');
                            return;
                        }

                        // Assume header is the first row, remove it.
                        rows.shift();
                        
                        const insumosExcel = rows.map(row => ({
                            nombre: row[0],
                            precio_por_gramo: row[1],
                            categoria: row[2]
                        }));

                        const nombresInsumosActuales = new Set(productos.map(p => p.nombre.trim().toLowerCase()));
                        const nuevosInsumos = [];

                        insumosExcel.forEach(insumo => {
                            const nombre = insumo.nombre ? insumo.nombre.toString().trim() : '';
                            const precio = parseFloat(insumo.precio_por_gramo);
                            const categoria = insumo.categoria ? insumo.categoria.toString().trim() : 'Sin Categoría';

                            if (nombre && !isNaN(precio) && precio > 0) {
                                if (!nombresInsumosActuales.has(nombre.toLowerCase())) {
                                    nuevosInsumos.push({
                                        nombre: nombre,
                                        precio_por_gramo: precio,
                                        categoria: categoria
                                    });
                                    // Add to set to avoid duplicates from the same file
                                    nombresInsumosActuales.add(nombre.toLowerCase());
                                }
                            }
                        });

                        if (nuevosInsumos.length === 0) {
                            alert('No se encontraron nuevos insumos para agregar. Todos los insumos del archivo ya existen o los datos son inválidos.');
                            return;
                        }

                        const batch = db.batch();
                        const insumosRef = db.collection('usuarios').doc(currentUser.uid).collection('insumos');

                        nuevosInsumos.forEach(insumo => {
                            const docRef = insumosRef.doc();
                            batch.set(docRef, insumo);
                        });

                        batch.commit().then(() => {
                            alert(`${nuevosInsumos.length} nuevo(s) insumo(s) agregado(s) con éxito.`);
                            cargarDatosDeUsuario(); // Reload all data to get new items and refresh UI
                        }).catch(error => {
                            console.error("Error al agregar insumos en lote: ", error);
                            alert('Hubo un error al guardar los nuevos insumos.');
                        });
                    } catch (error) {
                        console.error("Error al procesar el archivo Excel: ", error);
                        alert("Hubo un error al procesar el archivo. Asegúrate de que sea un archivo de Excel (.xlsx, .xls, .csv) válido y que las columnas estén en el orden: nombre, precio, categoría.");
                    }
                };

                reader.onerror = (ex) => {
                    console.log(ex);
                    alert('Hubo un error al leer el archivo.');
                };

                reader.readAsArrayBuffer(file);
            }

            function poblarFiltroCategorias() {
                const categorias = [...new Set(productos.map(p => p.categoria))].sort();
                filtroInsumoCategoria.innerHTML = '<option value="">Todas las categorías</option>';
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    filtroInsumoCategoria.appendChild(option);
                });
            }

            function filtrarYRenderizarInsumos() {
                const textoBusqueda = filtroInsumoNombre.value.toLowerCase();
                const categoriaSeleccionada = filtroInsumoCategoria.value;

                const insumosFiltrados = productos.filter(insumo => {
                    const matchNombre = insumo.nombre.toLowerCase().includes(textoBusqueda);
                    const matchCategoria = !categoriaSeleccionada || insumo.categoria === categoriaSeleccionada;
                    return matchNombre && matchCategoria;
                });

                renderInsumos(insumosFiltrados);
            }

            function renderInsumos(insumosParaRenderizar = productos) {
                tablaInsumos.innerHTML = '';
                if (!insumosParaRenderizar || insumosParaRenderizar.length === 0) {
                    tablaInsumos.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No se encontraron insumos con los filtros actuales.</td></tr>`;
                    return;
                }

                const insumosOrdenados = [...insumosParaRenderizar].sort((a, b) => {
                    if (a.categoria < b.categoria) return -1;
                    if (a.categoria > b.categoria) return 1;
                    if (a.nombre < b.nombre) return -1;
                    if (a.nombre > b.nombre) return 1;
                    return 0;
                });

                insumosOrdenados.forEach(insumo => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-2 font-medium">${insumo.nombre}</td>
                        <td class="px-4 py-2">$${insumo.precio_por_gramo.toFixed(2)}</td>
                        <td class="px-4 py-2">${insumo.categoria}</td>
                        <td class="px-4 py-2 text-right space-x-2 flex-shrink-0">
                            <button class="btn-secondary btn-xs btn-editar-insumo" data-id="${insumo.id}">Editar</button>
                            <button class="btn-danger btn-xs btn-eliminar-insumo" data-id="${insumo.id}">Eliminar</button>
                        </td>
                    `;
                    tablaInsumos.appendChild(tr);
                });
            }

            function resetFormInsumo() {
                formInsumo.reset();
                inputInsumoId.value = '';
                formInsumoTitulo.textContent = 'Agregar Nuevo Insumo';
                btnCancelarEdicionInsumo.classList.add('hidden');
            }

            function descargarRespaldoDatos() {
                if (!currentUser) return alert('Inicia sesión para descargar tus datos.');

                try {
                    // 1. Preparar datos (solo insumos)
                    const insumosSheet = XLSX.utils.json_to_sheet(productos.map(({ id, ...rest }) => rest));

                    // 2. Crear workbook y añadir hojas (solo insumos)
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, insumosSheet, "Insumos");

                    // 3. Generar y descargar archivo
                    const today = new Date().toISOString().slice(0, 10);
                    const fileName = `Respaldo_Insumos_${today}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                } catch (error) {
                    console.error("Error al generar el respaldo: ", error);
                    alert("Hubo un error al generar el archivo de respaldo.");
                }
            }

            // =================================================================
            // 5. ASIGNACIÓN DE EVENT LISTENERS
            // =================================================================
            // --- Autenticación
            loginForm.addEventListener('submit', e => {
                e.preventDefault();
                auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value)
                    .catch(error => { authError.textContent = error.message; authError.classList.remove('hidden'); });
            });

            registerForm.addEventListener('submit', e => {
                e.preventDefault();
                auth.createUserWithEmailAndPassword(document.getElementById('register-email').value, document.getElementById('register-password').value)
                    .then(userCredential => { crearInsumosBaseParaUsuario(userCredential.user); })
                    .catch(error => { authError.textContent = error.message; authError.classList.remove('hidden'); });
            });

            logoutBtn.addEventListener('click', () => auth.signOut());

            toggleAuthLink.addEventListener('click', e => {
                e.preventDefault();
                if (loginForm.classList.contains('hidden')) {
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                    authTitle.textContent = 'Iniciar Sesión';
                    toggleAuthLink.textContent = '¿No tienes cuenta? Regístrate';
                } else {
                    loginForm.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                    authTitle.textContent = 'Crear Cuenta';
                    toggleAuthLink.textContent = '¿Ya tienes cuenta? Inicia Sesión';
                }
                authError.classList.add('hidden');
            });

            googleSignInBtn.addEventListener('click', async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    const result = await auth.signInWithPopup(provider);
                    // Si es un usuario nuevo, crea su set de insumos base.
                    if (result.additionalUserInfo && result.additionalUserInfo.isNewUser) {
                        await crearInsumosBaseParaUsuario(result.user);
                    }
                    // onAuthStateChanged se encargará del resto.
                } catch (error) {
                    console.error("Error al iniciar sesión con Google: ", error);
                    authError.textContent = `Error con Google: ${error.message}`;
                    authError.classList.remove('hidden');
                }
            });

            // --- Navegación por Pestañas
            tabAgregarProducto.addEventListener('click', () => cambiarSeccion('agregar-producto'));
            tabCatalogo.addEventListener('click', () => cambiarSeccion('catalogo'));
            tabPropuesta.addEventListener('click', () => cambiarSeccion('propuesta'));
            tabInsumos.addEventListener('click', () => cambiarSeccion('insumos'));

            // --- Calculadora
            btnAgregar.addEventListener('click', () => {
                const nombreIngrediente = selectorIngrediente.value;
                const cantidad = parseFloat(inputCantidad.value);
                if (!cantidad || cantidad <= 0) return;
                const producto = productos.find(p => p.nombre === nombreIngrediente);
                receta.push({ nombre: nombreIngrediente, cantidad, costo: producto.precio_por_gramo * cantidad });
                inputCantidad.value = '';
                renderizarReceta();
            });

            btnAgregarGasto.addEventListener('click', () => {
                const descripcion = inputGastoDescripcion.value.trim();
                const monto = parseFloat(inputGastoMonto.value);
                if (!descripcion || !monto || monto <= 0) return;
                gastosAdicionales.push({ descripcion, monto });
                inputGastoDescripcion.value = '';
                inputGastoMonto.value = '';
                renderizarGastos();
            });

            listaReceta.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-danger')) {
                    receta.splice(e.target.dataset.index, 1);
                    renderizarReceta();
                }
            });

            listaGastos.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-danger')) {
                    gastosAdicionales.splice(e.target.dataset.index, 1);
                    renderizarGastos();
                }
            });

            btnNuevoRegistro.addEventListener('click', () => {
                receta = [];
                gastosAdicionales = [];
                inputRecetaNombre.value = '';
                inputRecetaCaracteristicas.value = '';
                inputRecetaCategoria.value = '';
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`receta-imagen-${i}`).value = '';
                    const preview = document.getElementById(`imagen-preview-${i}`);
                    const placeholder = document.getElementById(`placeholder-${i}`);
                    preview.src = '';
                    preview.classList.add('hidden');
                    placeholder.classList.remove('hidden');
                }
                renderizarReceta();
                renderizarGastos();
            });

            inputGananciaMinorista.addEventListener('input', calcularTotales);
            inputGananciaMayorista.addEventListener('input', calcularTotales);
            inputGastoPerdidaPct.addEventListener('input', calcularTotales);
            inputGastoProduccionPct.addEventListener('input', calcularTotales);
            btnGuardarCatalogo.addEventListener('click', guardarEnCatalogo);

            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(`receta-imagen-${i}`);
                const preview = document.getElementById(`imagen-preview-${i}`);
                const placeholder = document.getElementById(`placeholder-${i}`);

                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            preview.src = event.target.result;
                            preview.classList.remove('hidden');
                            placeholder.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        preview.src = '';
                        preview.classList.add('hidden');
                        placeholder.classList.remove('hidden');
                    }
                });
            }

            // --- Catálogo y Modales
            filtroCatalogoNombre.addEventListener('input', () => {
                paginaActualCatalogo = 1;
                renderizarCatalogo();
            });
            filtroCatalogoCategoria.addEventListener('change', () => {
                paginaActualCatalogo = 1;
                renderizarCatalogo();
            });

            catalogoContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-borrar')) borrarDelCatalogo(e.target.dataset.id);
                if (e.target.classList.contains('btn-ver-detalles')) mostrarDetalles(e.target.dataset.id);
            });

            modalCloseBtn.addEventListener('click', () => modalOverlay.classList.add('hidden'));
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) modalOverlay.classList.add('hidden'); });
            modalContent.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-guardar-cambios')) guardarCambios(e.target.dataset.id);
                if (e.target.classList.contains('btn-cancelar-modal')) modalOverlay.classList.add('hidden');
                if (e.target.classList.contains('btn-eliminar-imagen-modal')) {
                    const velaId = e.target.dataset.velaId;
                    const imageUrl = e.target.dataset.imageUrl;
                    const index = e.target.dataset.index;
                    
                    const confirmarBorradoModal = document.getElementById('confirmar-borrado-modal-overlay');
                    const btnConfirmar = document.getElementById('btn-confirmar-borrado');
                    
                    // Clonar y reemplazar para evitar listeners duplicados
                    const newBtnConfirmar = btnConfirmar.cloneNode(true);
                    btnConfirmar.parentNode.replaceChild(newBtnConfirmar, btnConfirmar);
                    
                    newBtnConfirmar.onclick = () => borrarImagenDeVela(velaId, imageUrl, index);
                    
                    confirmarBorradoModal.classList.remove('hidden');
                }
            });

            document.getElementById('btn-cancelar-borrado').addEventListener('click', () => {
                document.getElementById('confirmar-borrado-modal-overlay').classList.add('hidden');
            });

            // --- Propuestas
            btnPropuestaAgregarProducto.addEventListener('click', agregarProductoAPropuesta);
            inputDescuento.addEventListener('input', calcularTotalesPropuesta);
            inputEnvio.addEventListener('input', calcularTotalesPropuesta);
            inputImpuestoPct.addEventListener('input', calcularTotalesPropuesta);
            btnLimpiarPropuesta.addEventListener('click', limpiarPropuesta);
            btnGenerarPDFPropuesta.addEventListener('click', generarPDFPropuesta);
            btnGuardarPropuesta.addEventListener('click', guardarPropuesta);
            btnVerGuardadas.addEventListener('click', () => { renderizarListaPropuestas(); listaPropuestasModalOverlay.classList.remove('hidden'); });
            listaPropuestasModalCloseBtn.addEventListener('click', () => listaPropuestasModalOverlay.classList.add('hidden'));
            tablaPropuestasGuardadas.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-ver-propuesta')) { cargarPropuesta(e.target.dataset.id); listaPropuestasModalOverlay.classList.add('hidden'); }
                if (e.target.classList.contains('btn-eliminar-propuesta')) { eliminarPropuesta(e.target.dataset.id); }
            });
            listaProductosPropuesta.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-eliminar-producto-propuesta')) { propuestaActual.pedido.splice(e.target.dataset.index, 1); renderizarPedidoPropuesta(); }
            });

            // --- Insumos
            btnCargarExcel.addEventListener('click', () => {
                inputExcel.click();
            });

            inputExcel.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    cargarInsumosDesdeExcel(file);
                }
                e.target.value = ''; // Reset input to allow re-uploading the same file
            });

            formInsumo.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!currentUser) return;
                const insumo = { nombre: inputInsumoNombre.value, precio_por_gramo: parseFloat(inputInsumoPrecio.value), categoria: inputInsumoCategoria.value };
                const id = inputInsumoId.value;
                if (id) { // Actualizar
                    db.collection('usuarios').doc(currentUser.uid).collection('insumos').doc(id).update(insumo).then(() => {
                        const index = productos.findIndex(p => p.id === id);
                        productos[index] = { id, ...insumo };
                        resetFormInsumo();
                        poblarFiltroCategorias();
                        filtrarYRenderizarInsumos();
                        poblarSelectorIngredientes();
                    }).catch(err => console.error("Error al actualizar insumo: ", err));
                } else { // Crear
                    db.collection('usuarios').doc(currentUser.uid).collection('insumos').add(insumo).then(docRef => {
                        productos.push({ id: docRef.id, ...insumo });
                        resetFormInsumo();
                        poblarFiltroCategorias();
                        filtrarYRenderizarInsumos();
                        poblarSelectorIngredientes();
                    }).catch(err => console.error("Error al agregar insumo: ", err));
                }
            });

            tablaInsumos.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                if (!id) return;
                if (e.target.classList.contains('btn-editar-insumo')) {
                    const insumo = productos.find(p => p.id === id);
                    if (insumo) {
                        formInsumoTitulo.textContent = 'Editar Insumo';
                        inputInsumoId.value = insumo.id;
                        inputInsumoNombre.value = insumo.nombre;
                        inputInsumoPrecio.value = insumo.precio_por_gramo;
                        inputInsumoCategoria.value = insumo.categoria;
                        btnCancelarEdicionInsumo.classList.remove('hidden');
                    }
                }
                if (e.target.classList.contains('btn-eliminar-insumo')) {
                    if (confirm('¿Estás seguro de que quieres eliminar este insumo?')) {
                        db.collection('usuarios').doc(currentUser.uid).collection('insumos').doc(id).delete().then(() => {
                            productos = productos.filter(p => p.id !== id);
                            poblarFiltroCategorias();
                            filtrarYRenderizarInsumos();
                            poblarSelectorIngredientes();
                        }).catch(err => console.error("Error al eliminar insumo: ", err));
                    }
                }
            });

            btnCancelarEdicionInsumo.addEventListener('click', resetFormInsumo);

            btnDescargarDatos.addEventListener('click', descargarRespaldoDatos);

            filtroInsumoNombre.addEventListener('input', filtrarYRenderizarInsumos);
            filtroInsumoCategoria.addEventListener('change', filtrarYRenderizarInsumos);

            // =================================================================
            // 5.5 FUNCIONES PARA CATÁLOGO PÚBLICO DE CLIENTES
            // =================================================================
            let catalogoPublicoData = []; // Almacenar los datos para no recargarlos

            function poblarFiltroPublicoCategorias() {
                const filtroCategoria = document.getElementById('filtro-publico-categoria');
                const categorias = [...new Set(
                    catalogoPublicoData.flatMap(p => p.categoria || [])
                )].sort();
                filtroCategoria.innerHTML = '<option value="">Todas las categorías</option>';
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    filtroCategoria.appendChild(option);
                });
            }
            
            function renderizarCatalogoPublico() {
                const container = document.getElementById('catalogo-clientes-container');
                const msgVacio = document.getElementById('catalogo-clientes-vacio-msg');
                container.innerHTML = '';

                const textoBusqueda = document.getElementById('filtro-publico-nombre').value.toLowerCase();
                const categoriaSeleccionada = document.getElementById('filtro-publico-categoria').value;

                const catalogoFiltrado = catalogoPublicoData.filter(vela => {
                    const matchNombre = !textoBusqueda || vela.nombre.toLowerCase().includes(textoBusqueda);
                    const matchCategoria = !categoriaSeleccionada || (Array.isArray(vela.categoria) && vela.categoria.includes(categoriaSeleccionada));
                    return matchNombre && matchCategoria;
                });

                if (catalogoFiltrado.length === 0) {
                    msgVacio.textContent = 'No se encontraron productos con los filtros actuales.';
                    msgVacio.style.display = 'block';
                    container.appendChild(msgVacio); // Asegurarse de que el mensaje esté dentro del contenedor
                    return;
                }
                
                msgVacio.style.display = 'none';

                catalogoFiltrado.forEach(vela => {
                    const card = document.createElement('div');
                    card.className = 'card flex flex-col';

                    const costoTotal = calcularCostoTotalVela(vela);
                    const precioVentaMinorista = costoTotal * (1 + (vela.margenGananciaMinorista || 0) / 100);
                    
                    const numeroWhatsApp = '529994975170'; 
                    const mensajeWhatsApp = encodeURIComponent(`Hola, estoy interesado/a en el producto: ${vela.nombre}`);
                    const whatsappUrl = `https://wa.me/${numeroWhatsApp}?text=${mensajeWhatsApp}`;

                    const imagenHtml = vela.imagenUrl 
                        ? `<img src="${vela.imagenUrl}" alt="${vela.nombre}" class="w-full h-64 object-cover rounded-t-lg mb-4">`
                        : '<div class="w-full h-64 bg-gray-200 rounded-t-lg flex items-center justify-center mb-4"><span class="text-gray-500 text-sm">Sin imagen</span></div>';

                    const categoriasHtml = Array.isArray(vela.categoria) && vela.categoria.length > 0
                        ? `<div class="flex flex-wrap gap-1 mt-2">${vela.categoria.map(c => `<span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${c}</span>`).join('')}</div>`
                        : '';

                    card.innerHTML = `
                        ${imagenHtml}
                        <div class="p-4 flex-grow flex flex-col">
                            <h3 class="text-xl font-bold text-gray-800">${vela.nombre}</h3>
                            <p class="text-sm text-gray-600 my-3 flex-grow">${vela.caracteristicas || 'Descripción no disponible.'}</p>
                            ${categoriasHtml}
                            <div class="border-t pt-4 mt-4 flex justify-between items-center">
                                <span class="text-2xl font-extrabold text-indigo-700">$${precioVentaMinorista.toFixed(2)}</span>
                                <a href="${whatsappUrl}" target="_blank" rel="noopener noreferrer" class="btn-secondary inline-flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.651 4.383 1.803 6.166l-1.225 4.485 4.574-1.196z"/></svg>
                                    Contactar
                                </a>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            async function mostrarCatalogoPublico() {
                authContainer.classList.add('hidden');
                appContainer.classList.add('hidden');
                const seccionPublica = document.getElementById('seccion-catalogo-clientes');
                seccionPublica.classList.remove('hidden');

                try {
                    const publicUserId = 'MeVpNiYcH6RSwWzkzLGnvdROYgE3';
                    const catalogoSnapshot = await db.collection('usuarios').doc(publicUserId).collection('catalogo').get();
                    catalogoPublicoData = catalogoSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    poblarFiltroPublicoCategorias();
                    renderizarCatalogoPublico();

                    // Añadir event listeners para los filtros
                    document.getElementById('filtro-publico-nombre').addEventListener('input', renderizarCatalogoPublico);
                    document.getElementById('filtro-publico-categoria').addEventListener('change', renderizarCatalogoPublico);

                } catch (error) {
                    console.error("Error al cargar el catálogo público:", error);
                    const msgVacio = document.getElementById('catalogo-clientes-vacio-msg');
                    msgVacio.textContent = 'No se pudo cargar el catálogo. Por favor, revisa las reglas de seguridad de Firebase y que el UID sea correcto.';
                }
            }

            // =================================================================
            // 6. PUNTO DE ENTRADA PRINCIPAL
            // =================================================================
            
            // --- Lógica de Enrutamiento ---
            function manejarRuta() {
                if (window.location.hash === '#catalogo-clientes') {
                    mostrarCatalogoPublico();
                    return true; // Indica que se manejó una ruta pública
                }
                return false; // Indica que se debe seguir el flujo normal
            }

            // Primero, manejar la ruta. Si es una ruta pública, no continuamos con la lógica de autenticación.
            // --- Observador del estado de autenticación
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    userEmailSpan.textContent = user.email;
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    shareContainer.classList.remove('hidden'); // Mostrar contenedor de compartir
                    inicializarAplicacion();
                } else {
                    currentUser = null;
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    shareContainer.classList.add('hidden'); // Ocultar contenedor de compartir
                }
            });

            // --- Lógica para compartir catálogo
            compartirCatalogoBtn.addEventListener('click', () => {
                if (currentUser) {
                    const userId = currentUser.uid;
                    
                    // Construye la URL completa usando la ruta actual del navegador
                    const currentURL = window.location.href;
                    const pathBase = currentURL.substring(0, currentURL.lastIndexOf('/') + 1);
                    const enlaceCompleto = `${pathBase}catalogo.html?user=${userId}`;

                    navigator.clipboard.writeText(enlaceCompleto).then(() => {
                        mensajeCopiadoSpan.classList.remove('hidden'); // Mostrar mensaje
                        compartirCatalogoBtn.classList.add('hidden'); // Ocultar botón temporalmente
                        
                        setTimeout(() => {
                            mensajeCopiadoSpan.classList.add('hidden'); // Ocultar mensaje
                            compartirCatalogoBtn.classList.remove('hidden'); // Mostrar botón de nuevo
                        }, 2500); // Mostrar mensaje por 2.5 segundos
                    }).catch(err => {
                        console.error('Error al copiar el enlace: ', err);
                        alert("No se pudo copiar el enlace automáticamente. Por favor, cópialo manualmente: " + enlaceCompleto);
                    });
                } else {
                    alert("Por favor, inicia sesión para poder compartir tu catálogo.");
                }
            });
        });
    </script>
</body>
</html>